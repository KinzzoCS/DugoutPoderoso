<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dugout Poderoso</title>

  <!-- Bootstrap CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet" 
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
    crossorigin="anonymous"
  />

  <style>
    body {
      background-color: #1eff00;
      color: white;
    }

    .tabla-dugout {
      border: 2px solid #dc3545;
      background-color: #1e1e1e;
    }

    .tabla-dugout th {
      background-color: #343a40;
      color: white;
      border-bottom: 2px solid #dc3545;
    }

    .tabla-dugout td {
      background-color: #212529;
      color: #f8f9fa;
      vertical-align: middle;
      text-transform: uppercase;
    }

    .contenedor-central {
      min-height: 100vh;
    }

    .titulo {
      font-size: 1.5rem;
      color: #dc3545;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .tabla-dugout tr {
      height: 60px;
    }

    .hashtag-rojo {
      color: #dc3545;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container d-flex flex-column justify-content-center align-items-center contenedor-central" style="max-width: 800px;">

    <!-- Input y bot√≥n para iniciar chat -->
    <div class="mb-4 w-100">
      <label for="urlInput" class="form-label text-white fw-bold">Pega la URL del directo de YouTube:</label>
      <div class="input-group">
        <input type="url" class="form-control" id="urlInput" placeholder="https://www.youtube.com/watch?v=..." />
        <button id="iniciarBtn" class="btn btn-danger">Iniciar Chat</button>
      </div>
      <div id="statusMsg" class="mt-2 text-white"></div>
    </div>

    <!-- Tabla de mensajes -->
    <table class="table table-bordered tabla-dugout text-center w-100">
      <thead>
        <tr><th>Dugout Poderoso</th></tr>
      </thead>
      <tbody>
        <tr>
          <td id="comentario1">Esperando comentario...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Bootstrap JS -->
  <script>
  const comentarioEl = document.getElementById("comentario1");
  const urlInput = document.getElementById('urlInput');
  const iniciarBtn = document.getElementById('iniciarBtn');
  const statusMsg = document.getElementById('statusMsg');

  const hashtagsPermitidos = ["#mineros", "#lapoderosa", "Mineros", "#LaPoderosa"];
  const palabrasProhibidas = [
    "pendejo", "idiota", "est√∫pido", "mierda", "puta",
    "joto", "marica", "culero", "formula59", "minerostv", "odio"
  ];

  const mostrados = new Set();
  let colaMensajes = [];

  function normalizarTexto(texto) {
    return texto
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^\w# ]/g, "");
  }

  function contieneHashtagValido(texto) {
    return hashtagsPermitidos.some(tag => texto.includes(tag.toLowerCase()));
  }

  function contieneProhibidas(texto) {
    return palabrasProhibidas.some(p => texto.includes(p));
  }

  function resaltarHashtags(texto) {
    let resultado = texto;
    hashtagsPermitidos.forEach(tag => {
      const regex = new RegExp(tag, "gi");
      resultado = resultado.replace(regex, match => `<span class="hashtag-rojo">${match.toUpperCase()}</span>`);
    });
    return resultado;
  }

  function filtrarMensajes(mensajes) {
    const nuevos = [];
    for (const msg of mensajes) {
      const textoCrudo = msg.message || "";
      const texto = normalizarTexto(textoCrudo);
      if (mostrados.has(texto)) continue;
      if (!contieneHashtagValido(texto)) continue;
      if (contieneProhibidas(texto)) continue;
      mostrados.add(texto);
      nuevos.push(textoCrudo);
    }
    return nuevos;
  }

  async function actualizarMensajes() {
    console.log("üîÑ Solicitando mensajes...");

    try {
      const res = await fetch("/api/mensajes");
      if (!res.ok) throw new Error(`Respuesta HTTP ${res.status}`);
      const data = await res.json();
      const mensajes = data.mensajes || [];

      console.log(`üì• Recibidos: ${mensajes.length}`);
      const nuevos = filtrarMensajes(mensajes);
      console.log("üÜï Nuevos v√°lidos:", nuevos.length);
      colaMensajes.push(...nuevos);

    } catch (error) {
      console.error("‚ùå Error al obtener mensajes:", error);
      comentarioEl.textContent = "Error al cargar comentarios...";
    }
  }

  function mostrarSiguiente() {
    if (colaMensajes.length > 0) {
      const mensaje = colaMensajes.shift();
      comentarioEl.innerHTML = resaltarHashtags(mensaje);
    } else {
      comentarioEl.textContent = "Esperando comentario v√°lido...";
    }
  }

  iniciarBtn.addEventListener('click', async () => {
    const url = urlInput.value.trim();
    if (!url) {
      statusMsg.textContent = "‚ö†Ô∏è Por favor, ingresa una URL v√°lida.";
      return;
    }

    statusMsg.textContent = "‚è≥ Iniciando chat...";

    try {
      const res = await fetch('/api/iniciar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });

      const data = await res.json();

      if (!res.ok) {
        statusMsg.textContent = `‚ùå Error: ${data.error || 'No se pudo iniciar el chat'}`;
        return;
      }

      statusMsg.textContent = "‚úÖ Chat iniciado correctamente. Cargando mensajes...";
      mostrados.clear();
      colaMensajes = [];
      comentarioEl.textContent = "Esperando comentario...";
      actualizarMensajes(); // Primera carga
    } catch (error) {
      statusMsg.textContent = "‚ùå Error al iniciar el chat.";
      console.error("Error al iniciar chat:", error);
    }
  });

  // Consulta nueva tanda cada minuto
  setInterval(actualizarMensajes, 60000);

  // Muestra un mensaje cada 4 segundos
  setInterval(mostrarSiguiente, 4000);
</script>

</body>
</html>
