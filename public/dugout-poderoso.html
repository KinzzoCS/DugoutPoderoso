<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dugout Poderoso</title>

  <!-- Bootstrap CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet" 
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
    crossorigin="anonymous"
  />

  <style>
    body {
      background-color: #1eff00;
      color: white;
    }

    .tabla-dugout {
      border: 2px solid #dc3545;
      background-color: #1e1e1e;
    }

    .tabla-dugout th {
      background-color: #343a40;
      color: white;
      border-bottom: 2px solid #dc3545;
    }

    .tabla-dugout td {
      background-color: #212529;
      color: #f8f9fa;
      vertical-align: middle;
      text-transform: uppercase;
    }

    .contenedor-central {
      min-height: 100vh;
    }

    .titulo {
      font-size: 1.5rem;
      color: #dc3545;
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
    }

    .tabla-dugout tr {
      height: 60px;
    }

    .hashtag-rojo {
      color: #dc3545;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container d-flex flex-column justify-content-center align-items-center contenedor-central" style="max-width: 800px;">

    <!-- Input y bot√≥n para iniciar chat -->
    <div class="mb-4 w-100">
      <label for="urlInput" class="form-label text-white fw-bold">Pega la URL del directo de YouTube:</label>
      <div class="input-group">
        <input type="url" class="form-control" id="urlInput" placeholder="https://www.youtube.com/watch?v=..." />
        <button id="iniciarBtn" class="btn btn-danger">Iniciar Chat</button>
      </div>
      <div id="statusMsg" class="mt-2 text-white"></div>
    </div>

    <!-- Tabla de mensajes -->
    <table class="table table-bordered tabla-dugout text-center w-100">
      <thead>
        <tr><th>Dugout Poderoso</th></tr>
      </thead>
      <tbody>
        <tr>
          <td id="comentario1">Esperando comentario...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Bootstrap JS -->
  <script 
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" 
    integrity="sha384-VgpV2GdWxqMDZ6g4go6TZyRn+q2bpQEb+EXZtAv/6jQFQKQtaV6t24fjDxaIu4xk" 
    crossorigin="anonymous"
  ></script>

  <script>
    const comentarioEl = document.getElementById("comentario1");
    const urlInput = document.getElementById('urlInput');
    const iniciarBtn = document.getElementById('iniciarBtn');
    const statusMsg = document.getElementById('statusMsg');

    const hashtagsPermitidos = ["#mineros", "#lapoderosa"];
    const palabrasProhibidas = [
      "pendejo", "idiota", "est√∫pido", "mierda", "puta",
      "joto", "marica", "culero", "formula59", "minerostv", "odio"
    ];

    const recibidos = new Map();
    const mostrados = new Set();

    const MAX_MENSAJES = 300;

    console.log("üì° Dugout Poderoso activo. Esperando mensajes...");

    function normalizarTexto(texto) {
      return texto
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^\w# ]/g, "");
    }

    function contieneHashtagValido(texto) {
      return hashtagsPermitidos.some(tag => texto.includes(tag));
    }

    function contieneProhibidas(texto) {
      return palabrasProhibidas.some(p => texto.includes(p));
    }

    function resaltarHashtags(texto) {
      let resultado = texto;
      hashtagsPermitidos.forEach(tag => {
        const regex = new RegExp(tag, "gi");
        resultado = resultado.replace(regex, match => `<span class="hashtag-rojo">${match.toUpperCase()}</span>`);
      });
      return resultado;
    }

    function obtenerMensajeValido(mensajes) {
      for (const msg of mensajes) {
        const id = msg.id;
        const textoCrudo = msg.message || "";
        const texto = normalizarTexto(textoCrudo);

        if (mostrados.has(texto)) {
          console.log(`‚è© Ignorado (ya mostrado): ${textoCrudo}`);
          continue;
        }
        if (!contieneHashtagValido(texto)) {
          console.log(`üö´ Sin hashtag permitido: ${textoCrudo}`);
          continue;
        }
        if (contieneProhibidas(texto)) {
          console.log(`üõë Contiene palabra prohibida: ${textoCrudo}`);
          continue;
        }

        mostrados.add(texto);
        console.log(`‚úÖ Mostrando: ${textoCrudo}`);
        return textoCrudo;
      }

      console.log("üîç No se encontr√≥ mensaje v√°lido esta vez.");
      return null;
    }

    async function actualizarMensajes() {
      console.log("üîÑ Solicitando mensajes...");

      try {
        const res = await fetch("/api/mensajes");
        if (!res.ok) throw new Error(`Respuesta HTTP ${res.status}`);
        const data = await res.json();
        const mensajes = data.mensajes || [];

        console.log(`üì• Recibidos: ${mensajes.length}`);

        mensajes.forEach(m => {
          if (!recibidos.has(m.id)) {
            recibidos.set(m.id, m);
          }
        });

        // Limitar tama√±o para no saturar memoria
        if (recibidos.size > MAX_MENSAJES) {
          // Eliminar mensajes m√°s antiguos (FIFO)
          const keys = recibidos.keys();
          while (recibidos.size > MAX_MENSAJES) {
            const key = keys.next().value;
            recibidos.delete(key);
            mostrados.clear();  // Reseteamos para evitar bloqueo por filtro
            console.log(`üóëÔ∏è Eliminado mensaje viejo: ${key}`);
          }
        }

        const textoMostrar = obtenerMensajeValido([...recibidos.values()]);
        if (textoMostrar) {
          comentarioEl.innerHTML = resaltarHashtags(textoMostrar);
        } else {
          comentarioEl.textContent = "Esperando comentario v√°lido...";
        }

      } catch (error) {
        console.error("‚ùå Error al obtener mensajes:", error);
        comentarioEl.textContent = "Error al cargar comentarios...";
      }
    }

    iniciarBtn.addEventListener('click', async () => {
      const url = urlInput.value.trim();
      if (!url) {
        statusMsg.textContent = "‚ö†Ô∏è Por favor, ingresa una URL v√°lida.";
        return;
      }

      statusMsg.textContent = "‚è≥ Iniciando chat...";

      try {
        const res = await fetch('/api/iniciar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const data = await res.json();

        if (!res.ok) {
          statusMsg.textContent = `‚ùå Error: ${data.error || 'No se pudo iniciar el chat'}`;
          return;
        }

        statusMsg.textContent = "‚úÖ Chat iniciado correctamente. Cargando mensajes...";
        recibidos.clear();
        mostrados.clear();
        comentarioEl.textContent = "Esperando comentario...";
        actualizarMensajes();

      } catch (error) {
        statusMsg.textContent = "‚ùå Error al iniciar el chat.";
        console.error("Error al iniciar chat:", error);
      }
    });

    // Actualizamos mensajes cada minuto para mantenerlo fresco
    setInterval(actualizarMensajes, 60000);
  </script>
</body>
</html>
