<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dugout Poderoso</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body {
      background-color: #1a1a1a;
      color: #ffffff;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding-top: 40px;
    }

    .trapecio {
      width: 100%;
      height: 100px;
      background: #2c2c2c;
      color: #ffffff;
      font-weight: bold;
      clip-path: polygon(20% 0, 80% 0, 100% 100%, 0% 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin-bottom: 30px;
    }

    .comentario {
      font-size: 1.5rem;
      font-weight: bold;
      color: #ffffff;
      margin-top: 20px;
    }

    .hashtag {
      color: #ff4c4c;
    }

    #formulario {
      margin-top: 50px;
    }

    .mensajes-default {
      font-size: 1.2rem;
      color: #ccc;
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <div class="trapecio">Dugout <span class="hashtag">#Poderoso</span></div>

  <div id="formulario" class="container">
    <h4>Ingresa la URL del directo de YouTube:</h4>
    <input type="text" id="urlInput" class="form-control" placeholder="https://www.youtube.com/watch?v=..." />
    <button class="btn btn-danger mt-3" onclick="iniciarChat()">Iniciar</button>
  </div>

  <div class="comentario" id="comentario"></div>

  <div id="mensajesDefault" class="mensajes-default" style="display: none;">
    <p>üí¨ Comenta con <span class="hashtag">#Mineros</span> para aparecer aqu√≠.</p>
    <p>üóØ Usa <span class="hashtag">#LaPoderosa</span> en tu mensaje.</p>
    <p>üì£ Tu voz puede salir en vivo, ¬°hazte notar!</p>
  </div>

  <script>
    let mensajes = [];
    let indice = 0;
    let intervalo;

    async function iniciarChat() {
      const url = document.getElementById('urlInput').value;
      if (!url) return alert('Debes ingresar una URL');

      try {
        const res = await fetch('/api/iniciar', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error al iniciar el chat');

        document.getElementById('formulario').style.display = 'none';
        comenzarActualizacion();
      } catch (error) {
        console.error("‚ùå Error al iniciar el chat:", error);
        alert(error.message || 'Hubo un problema al iniciar el chat.');
      }
    }

    function mostrarComentario() {
      const div = document.getElementById('comentario');
      const info = document.getElementById('mensajesDefault');

      if (!mensajes.length) {
        div.innerHTML = '';
        info.style.display = 'block';
        return;
      }

      info.style.display = 'none';

      const m = mensajes[indice];
      const textoConColor = m.message.replace(/(#mineros|#lapoderosa)/gi, '<span class="hashtag">$1</span>');
      div.innerHTML = `${m.author}: ${textoConColor}`;

      indice = (indice + 1) % mensajes.length;
    }

    async function obtenerMensajes() {
      try {
        const res = await fetch('/api/mensajes-poderosos');
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Error al obtener mensajes');

        mensajes = data.mensajes;
        console.log("‚úÖ Mensajes actualizados:", mensajes);
        mostrarComentario();
      } catch (error) {
        console.error("‚ùå Error al actualizar mensajes:", error);
      }
    }

    function comenzarActualizacion() {
      obtenerMensajes();
      intervalo = setInterval(obtenerMensajes, 15000); // cada 15 segundos
    }
  </script>
</body>
</html>
