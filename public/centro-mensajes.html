<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Centro de Mensajes - Dugout</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="bg-light">
    <div class="container py-4">
      <h1 class="text-center mb-4">Centro de Mensajes</h1>

      <div class="mb-3">
        <label for="urlInput" class="form-label"
          >URL del directo de YouTube</label
        >
        <input
          type="text"
          class="form-control"
          id="urlInput"
          placeholder="Pega aquÃ­ la URL del directo"
        />
        <button class="btn btn-primary mt-2" id="iniciarBtn">Iniciar</button>
      </div>

      <div id="mensajes" class="list-group"></div>

      <div class="text-center mt-4">
        <button class="btn btn-success" id="actualizarBtn">
          ðŸ”„ Actualizar comentarios
        </button>
      </div>
    </div>

    <script>
      const cont = document.getElementById("mensajes");
      const actualizarBtn = document.getElementById("actualizarBtn");
      const iniciarBtn = document.getElementById("iniciarBtn");
      const urlInput = document.getElementById("urlInput");

      iniciarBtn.addEventListener("click", async () => {
        const url = urlInput.value.trim();
        if (!url) {
          alert("Por favor, pega la URL del directo de YouTube.");
          return;
        }

        const res = await fetch("/api/iniciar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ url }),
        });

        const data = await res.json();
        if (res.ok) {
          cargarMensajes();
        } else {
          alert(data.error || "Error al iniciar el chat.");
        }
      });

      async function cargarMensajes() {
        try {
          const res = await fetch("/api/cronistas");
          if (!res.ok) throw new Error("Error en la respuesta");

          const data = await res.json();
          cont.innerHTML = "";

          data.forEach((msg) => {
            const div = document.createElement("div");
            div.className = "list-group-item d-flex align-items-center gap-3";

            div.innerHTML = `
            <img src="${
              msg.foto || "https://via.placeholder.com/60"
            }" alt="Foto de ${msg.autor}" 
                 style="width:60px; height:60px; border-radius:50%; object-fit:cover; border:1px solid #dc3545;">
            <div class="flex-grow-1">
              <div><strong>${msg.autor}</strong></div>
              <div>${msg.texto}</div>
            </div>
            <button class="btn btn-sm btn-outline-danger">LeÃ­do</button>
          `;

            const btn = div.querySelector("button");
            btn.addEventListener("click", async () => {
              try {
                const delRes = await fetch(`/api/cronistas/${msg.timestamp}`, {
                  method: "DELETE",
                });
                if (!delRes.ok) throw new Error("No se pudo borrar");

                cont.removeChild(div);
              } catch (e) {
                alert("Error al borrar comentario");
              }
            });

            cont.appendChild(div);
          });
        } catch (error) {
          console.error("Error al cargar mensajes:", error);
        }
      }

      actualizarBtn.addEventListener("click", cargarMensajes);

      // Carga inicial automÃ¡tica
      cargarMensajes();
    </script>
  </body>
</html>
